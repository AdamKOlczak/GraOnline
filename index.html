<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Prosta gra z Firebase</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; }
  #grid {
    margin: 20px auto;
    display: grid;
    grid-template-columns: repeat(8, 50px);
    grid-template-rows: repeat(8, 50px);
    gap: 2px;
    width: max-content;
  }
  .cell {
    width: 50px; height: 50px;
    background: #eee;
    border: 1px solid #ccc;
    display: flex; justify-content: center; align-items: center;
    font-weight: bold;
    font-size: 24px;
    user-select: none;
  }
  .player1 { background: red; color: white; }
  .player2 { background: green; color: white; }
  #status { margin-top: 15px; font-size: 18px; }
  button:disabled { opacity: 0.5; }
  #console {
    margin-top: 15px; background: black; color: lime; 
    padding: 5px; font-family: monospace; font-size: 12px; 
    max-height: 150px; overflow-y: auto;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>Gra z Firebase - statki</h1>

<button id="btnNewGame">Nowa gra</button>
<br/><br/>
<button id="btnJoinP1">Dołącz jako Player1 (Czerwony)</button>
<button id="btnJoinP2">Dołącz jako Player2 (Zielony)</button>
<br/><br/>
<label>Wpisz kod gry:</label>
<input type="text" id="gameCodeInput" maxlength="6" style="text-transform: uppercase;"/>
<button id="btnJoinGame">Dołącz do gry</button>
  
<div id="status">Kliknij "Nowa gra" lub dołącz do gry</div>

<div id="grid"></div>

<div id="console"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyATOiD3Hp077WyGNi50KFTCxx_yrmuyxf0",
    authDomain: "gratest-cfc14.firebaseapp.com",
    databaseURL: "https://gratest-cfc14-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gratest-cfc14",
    storageBucket: "gratest-cfc14.firebasestorage.app",
    messagingSenderId: "26328738989",
    appId: "1:26328738989:web:18484211ec540a9cf66a24"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // UI Elements
  const btnNewGame = document.getElementById('btnNewGame');
  const btnJoinP1 = document.getElementById('btnJoinP1');
  const btnJoinP2 = document.getElementById('btnJoinP2');
  const statusEl = document.getElementById('status');
  const gridEl = document.getElementById('grid');
  const consoleEl = document.getElementById('console');

  // Game state
  let gameId = null;
  let player = null; // "player1" or "player2"
  let currentTurn = null;
  let gameData = null;

  // Create 8x8 grid
  function createGrid() {
    gridEl.innerHTML = '';
    for(let i=0; i<64; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.dataset.index = i;
      gridEl.appendChild(cell);
    }
  }

  createGrid();

  // Logging helper
  function log(msg) {
    const time = new Date().toLocaleTimeString();
    consoleEl.textContent += `[${time}] ${msg}\n`;
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  // Generate random game ID (6 chars)
  function generateGameId() {
    return Math.random().toString(36).substring(2,8).toUpperCase();
  }

  // Random wind: "NW" or "SE"
  function randomWind() {
    return Math.random() < 0.5 ? 'NW' : 'SE';
  }

  // Update grid display
  function updateGrid() {
    if (!gameData) return;
    // Clear all cells
    for(let cell of gridEl.children) {
      cell.textContent = '';
      cell.classList.remove('player1', 'player2');
    }
    // Place players
    if (gameData.p1) {
      const idx = gameData.p1.row * 8 + gameData.p1.col;
      const cell = gridEl.children[idx];
      cell.textContent = 'X';
      cell.classList.add('player1');
    }
    if (gameData.p2) {
      const idx = gameData.p2.row * 8 + gameData.p2.col;
      const cell = gridEl.children[idx];
      cell.textContent = 'X';
      cell.classList.add('player2');
    }
  }

  // Update status and buttons
  function updateUI() {
    if (!gameId) {
      statusEl.textContent = 'Kliknij "Nowa gra" lub dołącz do istniejącej';
      btnJoinP1.disabled = true;
      btnJoinP2.disabled = true;
      return;
    }

    btnJoinP1.disabled = false;
    btnJoinP2.disabled = false;

    if (gameData) {
      statusEl.textContent = `Gra: ${gameId} | Tura: ${gameData.currentTurn} | Wiatr: ${gameData.wind}`;
      if (gameData.p1) btnJoinP1.disabled = true;
      if (gameData.p2) btnJoinP2.disabled = true;
      if (player) {
        statusEl.textContent += ` | Jesteś: ${player}`;
        if (currentTurn !== player) {
          statusEl.textContent += " - czekaj na swoją turę";
        } else {
          statusEl.textContent += " - twoja tura!";
        }
      } else {
        statusEl.textContent += " | Nie dołączono jeszcze";
      }
    }
  }

  // Listen for game updates
  function listenToGame(id) {
    db.ref('games/' + id).on('value', snapshot => {
      const val = snapshot.val();
      if (!val) {
        log(`Gra ${id} usunięta lub nie istnieje`);
        gameData = null;
        updateUI();
        updateGrid();
        return;
      }
      gameData = val;
      currentTurn = val.currentTurn;
      log(`Aktualizacja gry: ${JSON.stringify(val)}`);
      updateUI();
      updateGrid();
    });
  }

  // New game creation
  btnNewGame.onclick = () => {
    gameId = generateGameId();
    player = null;
    currentTurn = 'player1';

    const newGame = {
      currentTurn: 'player1',
      p1: null,
      p2: null,
      wind: randomWind()
    };

    db.ref('games/' + gameId).set(newGame).then(() => {
      log(`Utworzono grę ${gameId}, czekaj na graczy`);
      listenToGame(gameId);
      updateUI();
    });
  };

  // Join as Player1
  btnJoinP1.onclick = () => {
    if (!gameId) {
      alert("Najpierw utwórz lub wpisz ID gry");
      return;
    }
    db.ref('games/' + gameId).once('value').then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("Gra nie istnieje");
        return;
      }
      if (data.p1) {
        alert("Player1 już jest zajęty");
        return;
      }
      player = 'player1';
      // Initial position bottom-left corner (row 7, col 0)
      db.ref('games/' + gameId + '/p1').set({row:7, col:0});
      log("Dołączyłeś jako Player1 (czerwony)");
      listenToGame(gameId);
      updateUI();
    });
  };

  // Join as Player2
  btnJoinP2.onclick = () => {
    if (!gameId) {
      alert("Najpierw utwórz lub wpisz ID gry");
      return;
    }
    db.ref('games/' + gameId).once('value').then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("Gra nie istnieje");
        return;
      }
      if (data.p2) {
        alert("Player2 już jest zajęty");
        return;
      }
      player = 'player2';
      // Initial position top-right corner (row 0, col 7)
      db.ref('games/' + gameId + '/p2').set({row:0, col:7});
      log("Dołączyłeś jako Player2 (zielony)");
      listenToGame(gameId);
      updateUI();
    });
  };

  // Movement controls: arrow keys or buttons to move your player if it's your turn
  // Let's add simple buttons below grid for moves (up, down, left, right, and diagonals)
  // Also a button "End Turn"

  const moves = {
    "↖": {dr:-1, dc:-1},
    "↑":  {dr:-1, dc: 0},
    "↗": {dr:-1, dc: 1},
    "←":  {dr: 0, dc:-1},
    "→":  {dr: 0, dc: 1},
    "↙": {dr: 1, dc:-1},
    "↓":  {dr: 1, dc: 0},
    "↘": {dr: 1, dc: 1},
  };

  // Create movement buttons
  const controlsDiv = document.createElement('div');
  controlsDiv.style.marginTop = '15px';

  for (const [symbol, {dr, dc}] of Object.entries(moves)) {
    const btn = document.createElement('button');
    btn.textContent = symbol;
    btn.title = `Move ${symbol}`;
    btn.style.width = '40px';
    btn.style.height = '40px';
    btn.style.margin = '2px';
    btn.onclick = () => movePlayer(dr, dc);
    controlsDiv.appendChild(btn);
  }

  // End turn button
  const endTurnBtn = document.createElement('button');
  endTurnBtn.textContent = 'Zakończ turę';
  endTurnBtn.style.marginLeft = '10px';
  endTurnBtn.onclick = endTurn;
  controlsDiv.appendChild(endTurnBtn);

  document.body.insertBefore(controlsDiv, consoleEl);

  // Move player if it's their turn
  function movePlayer(dr, dc) {
    if (!player) {
      alert("Dołącz jako gracz, aby się ruszać");
      return;
    }
    if (currentTurn !== player) {
      alert("Nie twoja tura");
      return;
    }
    if (!gameData) return;

    let pos = gameData[player];
    if (!pos) return;

    // Calculate new position with wrap-around (snake map)
    let newRow = (pos.row + dr + 8) % 8;
    let newCol = (pos.col + dc + 8) % 8;

    // Update position locally
    const updateObj = {};
    updateObj[player] = {row: newRow, col: newCol};

    db.ref('games/' + gameId).update(updateObj)
      .then(() => log(`Ruch ${player}: (${pos.row},${pos.col}) -> (${newRow},${newCol})`))
      .catch(e => log("Błąd ruchu: " + e));
  }

  // End turn: switch currentTurn to other player
  function endTurn() {
    if (!player) {
      alert("Dołącz jako gracz, aby zakończyć turę");
      return;
    }
    if (currentTurn !== player) {
      alert("Nie twoja tura");
      return;
    }
    const nextTurn = player === 'player1' ? 'player2' : 'player1';
    db.ref('games/' + gameId).update({currentTurn: nextTurn})
      .then(() => log(`${player} zakończył turę, teraz ${nextTurn}`))
      .catch(e => log("Błąd zmiany tury: " + e));
  }

  // Start with buttons disabled until new game is created
  btnJoinP1.disabled = true;
  btnJoinP2.disabled = true;

  // Optional: add input to join existing game by ID (not included here, can add later)

  const gameCodeInput = document.getElementById('gameCodeInput');
const btnJoinGame = document.getElementById('btnJoinGame');

btnJoinGame.onclick = () => {
  const id = gameCodeInput.value.trim().toUpperCase();
  if (!id) {
    alert("Wpisz kod gry");
    return;
  }
  // Sprawdź, czy gra istnieje
  db.ref('games/' + id).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      alert("Gra o takim kodzie nie istnieje");
      return;
    }
    gameId = id;
    player = null;
    listenToGame(gameId);
    updateUI();
    log(`Dołączono do gry ${gameId}, wybierz swoją rolę`);
  });
};
</script>

</body>
</html>

